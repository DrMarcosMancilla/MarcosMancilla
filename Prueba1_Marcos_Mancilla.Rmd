---
title: "QTL-SRS"
author: "Marcos Mancilla"
date: "16/10/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(readxl)
library(graphics)
library(psych)
library(stats)
library(dplyr)
library(tidyr)
library(ggplot2)
```

# Realizando análisis exploratorio de datos
```{r, warning=FALSE, message=FALSE}
dat <- read_excel("dataset2.xls")
summary(dat)
head(dat)
str(dat)
```

# Graficamos variables de interés (histogramas, boxplots, densidad y densidad acumulada)

# Peces por subgrupo
```{r}
ggplot(dat, aes(x = N_peces, fill=Subgrupo)) +
  geom_histogram()
```

```{r}
ggplot(dat, aes(x = Subgrupo, y = N_peces, fill=Subgrupo)) +
  geom_boxplot()
```

```{r}
plot(density(dat$N_peces), main="Densidad empírica", xlab="N_peces")
```

```{r}
plot(ecdf(dat$N_peces), main="Distribución acumulada empírica", xlab="N_peces")
```

# Biomasa viva por subgrupo
```{r}
ggplot(dat, aes(x = Biomasa_kg, fill=Subgrupo)) +
  geom_histogram()
```

```{r}
ggplot(dat, aes(x=Subgrupo, y = Biomasa_kg, fill=Subgrupo)) +
  geom_boxplot()
```

```{r}
plot(density(dat$Biomasa_kg), main="Densidad empírica", xlab="Biomasa (kg)")
```

```{r}
plot(ecdf(dat$Biomasa_kg), main="Distribución acumulada empírica", xlab="Biomasa_kg")
```

# Mortalidad (n° peces) por subgrupo
```{r}
ggplot(dat, aes(x = Mortalidad, fill=Subgrupo)) +
  geom_histogram()+ scale_x_continuous(limit = c(0,15))+ scale_y_continuous(limit = c(0,2000))
```

```{r}
ggplot(dat, aes(x=Subgrupo, y = Mortalidad, fill=Subgrupo)) +
  geom_boxplot()+ scale_y_continuous(limit = c(0,15))
```

```{r}
plot(density(dat$Mortalidad), main="Densidad empírica", xlab="Mortalidad (n)")
```

```{r}
plot(ecdf(dat$Mortalidad), main="Distribución acumulada empírica", xlab="Mortalidad")
```

# Biomasa de la mortalidad por subgrupo
```{r}
ggplot(dat, aes(x = Mortalidad_Biomasa_kg, fill=Subgrupo)) +
  geom_histogram()+ scale_x_continuous(limit = c(0,15))+ scale_y_continuous(limit = c(0,1000))
```

```{r}
ggplot(dat, aes(x=Subgrupo, y = Mortalidad_Biomasa_kg, fill=Subgrupo)) +
  geom_boxplot()+ scale_y_continuous(limit = c(0,15))
```

```{r}
plot(density(dat$Mortalidad_Biomasa_kg), main="Densidad empírica", xlab="Biomasa Mortalidad (kg)")
```

```{r}
plot(ecdf(dat$Mortalidad), main="Distribución acumulada empírica", xlab="Biomasa Mortalidad (kg)")
```


```{r}
dat1 <- dat
table(dat1$Subgrupo)
table(dat1$Centro)
dat1$Centro <- as.factor(dat1$Centro)
dat1$Subgrupo <- as.factor(dat1$Subgrupo)
dat1$Unidad <- as.factor(dat1$Unidad)
str(dat1)
summary(dat1)
```

# Hacemos boxplot de variable respuesta en función de otras variables
```{r}
ggplot(dat1, aes(x=Centro, y = Mortalidad, fill=Subgrupo)) +
  geom_boxplot()+ scale_y_continuous(limit = c(0,15))
```

```{r}
ggplot(dat1, aes(x=Unidad, y = Mortalidad, fill=Subgrupo)) +
  geom_boxplot()+ scale_y_continuous(limit = c(0,40))
```

# Calculamos el número de observaciones por Subgrupo. Luego expresamos la cifra como proporción.
```{r}
table(dat$Subgrupo,dat$Centro)
tabla1 <- with(dat,table(Subgrupo,Centro))
prop.table(tabla1)
tabla1_prop <- with(dat,prop.table(tabla1))
knitr::kable(tabla1_prop,caption ="Proporción datos por Subgrupo de peces en diferentes Centros")
```

# Los datos no están balanceados. Hay más observaciones para el Subgrupo QTL2 (70,7%) que para otros subgrupos. El Subgrupo en menor proporción es el SQTL que está presente solo en Centro C.
```{r}
df1 <-dat %>%
  select(Subgrupo, Centro, Unidad, Biomasa_kg, N_peces)%>%
  group_by(Subgrupo, Centro, Unidad)%>%
  summarize(Maximo=max(N_peces), Minimo=min(N_peces), Max_Biom=round(max(Biomasa_kg),0))
knitr::kable(df1,caption = "N° de peces por unidad (jaula)")
```

# El análisis anterior indica que la mayoría de las unidades (jaulas) se cosecharon al final del periodo de observación (Mínimo = 0), quedando solo 9 jaulas con peces. Si sumamos el número de peces por Subgrupo, confirmamos que el Subgrupo QTL2 está sobrerrepresentado. Aprovechamos de calcular la biomasa que llegaron a desarrollar estos Subgrupos.
```{r}
df2 <-df1 %>%
  select(Subgrupo, Maximo, Max_Biom)%>%
  group_by(Subgrupo)%>%
    summarize(N_Peces=sum(Maximo), Biomasa_total=sum(Max_Biom))
knitr::kable(df2,caption = "N° de peces y biomasa por Subgrupo")
```

# Calculamos ahora la mortalidad asociada a cada Unidad.
```{r}
df3 <-dat %>%
  select(Subgrupo, Centro, Unidad, Mortalidad, Mortalidad_Biomasa_kg)%>%
  group_by(Subgrupo, Centro, Unidad)%>%
  summarize(Mort_peces = sum(Mortalidad), Biomas_mort=round(sum(Mortalidad_Biomasa_kg), 0))
knitr::kable(df3,caption = "Mortalidad de peces por Unidad")
```

# Ahora, calculamos la mortalidad asociada por Subgrupo.
```{r}
df4 <-df3 %>%
  select(Subgrupo, Mort_peces, Biomas_mort)%>%
  group_by(Subgrupo)%>%
    summarize(Mortalidad = sum(Mort_peces), Biomasa_dead = sum(Biomas_mort))
knitr::kable(df4,caption = "Mortalidad de peces por Subgrupo")
```

# Queremos agregar a esta tabla las columnas de n° de peces y biomasa total del df2.
```{r}
Tabla3 <- merge(df2,df4,by="Subgrupo")
knitr::kable(Tabla3,caption = "Resumen datos de Subgrupos")
```