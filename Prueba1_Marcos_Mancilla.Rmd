---
title: "QTL-SRS"
author: "Marcos Mancilla"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(readxl)
library(graphics)
library(psych)
library(stats)
library(dplyr)
library(tidyr)
library(ggplot2)
library(knitr)
```

# Realizando análisis exploratorio de datos

```{r, warning=FALSE, message=FALSE}
# Este bloque de codigos importa los datos
dat <- read_excel("dataset2.xls")
summary(dat)
head(dat)
str(dat)
```

# Observamos que el set de datos tiene 12.825 observaciones de 12 variables. Existe una variable fecha, 3 variables como texto (Centro, Unidad y Subgrupo) y 8 variables numéricas.

# Graficamos variables de interés (histogramas, boxplots, densidad y densidad acumulada)

# 1.- Peces por subgrupo

```{r, warning=FALSE, message=FALSE}
ggplot(dat, aes(x = N_peces, fill=Subgrupo)) +
  geom_histogram(bins=30)+ labs(title = "Figura 1. Histograma variable N° de peces")
```

```{r}
ggplot(dat, aes(x = Subgrupo, y = N_peces, fill=Subgrupo)) +
  geom_boxplot()+ labs(title = "Figura 2. Boxplot variable N° de peces")
```

```{r}
plot(density(dat$N_peces), main="Figura 3. Densidad empírica variable N° peces", xlab="N_peces")
```

```{r}
plot(ecdf(dat$N_peces), main="Figura 4. Distribución acumulada empírica variable N° peces", xlab="N_peces")
```

# 2.- Biomasa viva por subgrupo
```{r, warning=FALSE, message=FALSE}
ggplot(dat, aes(x = Biomasa_kg, fill=Subgrupo)) +
  geom_histogram(bins = 30)+ labs(title = "Figura 5. Histograma variable Biomasa")
```

```{r}
ggplot(dat, aes(x=Subgrupo, y = Biomasa_kg, fill=Subgrupo)) +
  geom_boxplot()+ labs(title = "Figura 6. Boxplot variable Biomasa")
```

```{r}
plot(density(dat$Biomasa_kg), main="Figura 7. Densidad empírica variable Biomasa", xlab="Biomasa (kg)")
```

```{r}
plot(ecdf(dat$Biomasa_kg), main="Figura 8. Distribución acumulada empírica variable Biomasa", xlab="Biomasa_kg")
```

# 3.- Mortalidad (n° peces) por subgrupo (variable respuesta)
```{r, warning=FALSE, message=FALSE}
ggplot(dat, aes(x = Mortalidad, fill=Subgrupo)) +
  geom_histogram(bin=30)+ labs(title = "Figura 9. Histograma variable Mortalidad")
```

# Para apreciar mejor como se comporta esta variable, ajustamos el set de datos filtrando valores de Mortalidad <= 15.

```{r}
dat2 <-dat %>%
  select(Subgrupo, Centro, Unidad, Biomasa_kg, N_peces, Mortalidad)%>%
  filter(Mortalidad <= 15)
```

# Se genera nuevo histograma

```{r, warning=FALSE, message=FALSE}
ggplot(dat2, aes(x = Mortalidad, fill=Subgrupo)) +
  geom_histogram(bin=30)+ labs(title = "Figura 10. Histograma variable Mortalidad ajustado")
```

```{r, warning=FALSE, message=FALSE}
ggplot(dat, aes(x=Subgrupo, y = Mortalidad, fill=Subgrupo)) +
  geom_boxplot()+ scale_y_continuous(limit = c(0,15))+ labs(title = "Figura 11. Boxplot variable Mortalidad")
```

```{r}
plot(density(dat$Mortalidad), main="Figura 12. Densidad empírica variable Mortalidad", xlab="Mortalidad (n)")
```

```{r}
plot(ecdf(dat$Mortalidad), main="Figura 13. Distribución acumulada empírica variable Mortalidad", xlab="Mortalidad")
```

# 4.- Biomasa de la mortalidad por subgrupo
```{r, warning=FALSE, message=FALSE}
ggplot(dat, aes(x = Mortalidad_Biomasa_kg, fill=Subgrupo)) +
  geom_histogram(bins = 30)+ labs(title = "Figura 14. Histograma variable Biomasa de Mortalidad")
```

```{r, warning=FALSE, message=FALSE}
ggplot(dat, aes(x=Subgrupo, y = Mortalidad_Biomasa_kg, fill=Subgrupo)) +
  geom_boxplot()+ scale_y_continuous(limit = c(0,15))+ labs(title = "Figura 15. Boxplot variable Biomasa de Mortalidad")
```

```{r}
plot(density(dat$Mortalidad_Biomasa_kg), main="Figura 16. Densidad empírica variable Biomasa de Mortalidad", xlab="Biomasa Mortalidad (kg)")
```

```{r}
plot(ecdf(dat$Mortalidad), main="Figura 17. Distribución acumulada empírica variable Biomasa de Mortalidad", xlab="Biomasa Mortalidad (kg)")
```

# Hacemos boxplot de variable respuesta en función de otras variables de interés

```{r, warning=FALSE, message=FALSE}
ggplot(dat, aes(x=Centro, y = Mortalidad, fill=Subgrupo)) +
  geom_boxplot()+ scale_y_continuous(limit = c(0,15))+ labs(title = "Figura 18. Boxplot variable Mortalidad para centro y subgrupo")
```

# Transformaciones de variables a factor

```{r}
dat1 <- dat
table(dat1$Subgrupo)
table(dat1$Centro)
dat1$Centro <- as.factor(dat1$Centro)
dat1$Subgrupo <- as.factor(dat1$Subgrupo)
dat1$Unidad <- as.factor(dat1$Unidad)
str(dat1)
summary(dat1)
```

# Determinar si los datos están balanceados

# Calculamos el número de observaciones por Subgrupo. Luego expresamos la cifra como proporción.
```{r}
table(dat$Subgrupo,dat$Centro)
tabla1 <- with(dat,table(Subgrupo,Centro))
prop.table(tabla1)
tabla1_prop <- with(dat,prop.table(tabla1))
knitr::kable(tabla1_prop,caption ="Proporción datos por Subgrupo de peces en diferentes Centros")
```

# Los datos no están balanceados. Hay más observaciones para el Subgrupo QTL2 (70,7%) que para otros subgrupos. El Subgrupo en menor proporción es el SQTL que está presente solo en Centro C.
```{r, warning=FALSE, message=FALSE}
df1 <-dat %>%
  select(Subgrupo, Centro, Unidad, Biomasa_kg, N_peces)%>%
  group_by(Subgrupo, Centro, Unidad)%>%
  summarize(Maximo=max(N_peces), Minimo=min(N_peces), Max_Biom=round(max(Biomasa_kg),0))
knitr::kable(df1,caption = "N° de peces por unidad (jaula)")
```

# El análisis anterior indica que la mayoría de las unidades (jaulas) se cosecharon al final del periodo de observación (Mínimo = 0), quedando solo 9 jaulas con peces. Si sumamos el número de peces por Subgrupo, confirmamos que el Subgrupo QTL2 está sobrerrepresentado. Aprovechamos de calcular la biomasa que llegaron a desarrollar estos Subgrupos.
```{r, warning=FALSE, message=FALSE}
df2 <-df1 %>%
  select(Subgrupo, Maximo, Max_Biom)%>%
  group_by(Subgrupo)%>%
    summarize(N_Peces=sum(Maximo), Biomasa_total=sum(Max_Biom))
knitr::kable(df2,caption = "N° de peces y biomasa por Subgrupo")
```

# Calculamos ahora la mortalidad asociada a cada Unidad.
```{r, warning=FALSE, message=FALSE}
df3 <-dat %>%
  select(Subgrupo, Centro, Unidad, Mortalidad, Mortalidad_Biomasa_kg)%>%
  group_by(Subgrupo, Centro, Unidad)%>%
  summarize(Mort_peces = sum(Mortalidad), Biomas_mort=round(sum(Mortalidad_Biomasa_kg), 0))
knitr::kable(df3,caption = "Mortalidad de peces por Unidad")
```

# Ahora, calculamos la mortalidad asociada por Subgrupo.
```{r, warning=FALSE, message=FALSE}
df4 <-df3 %>%
  select(Subgrupo, Mort_peces, Biomas_mort)%>%
  group_by(Subgrupo)%>%
    summarize(Mortalidad = sum(Mort_peces), Biomasa_dead = sum(Biomas_mort))
knitr::kable(df4,caption = "Mortalidad de peces por Subgrupo")
```

# Queremos agregar a esta tabla las columnas de n° de peces y biomasa total del df2.
```{r}
Tabla3 <- merge(df2,df4,by="Subgrupo")
knitr::kable(Tabla3,caption = "Resumen datos de Subgrupos")
```